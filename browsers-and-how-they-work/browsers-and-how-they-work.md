# ブラウザと、その動作

- ホームページを閲覧するためのソフトウェア
  - これがないと始まらない
- 前項まででまとめた、情報のやりとりがWebブラウザで行われている  
  - WebブラウザからWebサーバへHTTP(HTTPS)のリクエストを送信し、それを受け取ったWebサーバはレスポンスを返す
  - WebブラウザとWebサーバのやりとりは、 **OSI参照モデル** の物理層からアプリケーション層に向けて処理が行われている

## OSI参照モデルってなに？

- ネットワークで利用されている通信プロトコルについて、それぞれの役割を分類して、明確にするためのモデル
  - 通信についての仕組みをまとめて整理したものの1つ
- 国際標準化機構(ISO)が作った
- 7つの階層に分けて定義

### OSI参照モデルの図

|    | OSI参照モデル     |                             役割                                |   領域  | 関連装置 |  
| -- | --------------- | ------------------------------------------------------------- | -------- | ---- |  
| 7  | アプリケーション層   | アプリケーションごとのサービスを提供することについて                        | ソフトウエア | ゲートウェイ |  
| 6  | プレゼンテーション層 | アプリケーションデータを通信に適した形に変換することについて　                 |     〃    | 〃 |  
| 5  | セッション層       | データを流す物理的な通信路(コネクション)の確率と切断について                |     〃    | 〃 |  
| 4  | トランスポート層    | データを通信相手に確実に届ける方法について                              | ネットワーク | ルータ、L3スイッチ |  
| 3  | ネットワーク層     | 同一もしくは異なるネットワークの機器と接続するためにアドレスと経路の選択について    |    〃    | ブリッジ、L1スイッチ |  
| 2  | データリンク層     | 直接接続された機器との間に論理的な伝送路(データリンク)を確立する方法について   |    〃    | ブリッジ、L2スイッチ|  
| 1  | 物理層          | ネットワークケーブルの材質や、コネクタの形式、ピンの並び方など、物理的な要素全てについて | ハードウェア | LANケーブル、NIC |

##  ブラウザが行っていること詳しく

- ブラウザは、ユーザの選択したウェブリソースをサーバに要求。それをブラウザウィンドウに表示する。  
リソースとは、主にHTMLドキュメントのことだが、PDFや画像なども含まれる。  
  → それらのリソースの場所はURI(Uniform Resource Identifier)をユーザが指定する。

- 様々な種類のブラウザが存在するがそれぞれのUIは共通したものが多い。

### 共通するブラウザのUIの要素

- URIを入力するためのアドレスバー
- 「戻る」ボタンと「進む」ボタン
- ブックマーク機能
- 現在のドキュメントを更新するための「更新」ボタン、読み込みを中止するための「中止」ボタン
- ホームのページに移動する「ホーム」ボタン

### ブラウザの構成要素

1. **ユーザーインターフェース:** アドレスバー、戻る・進むボタン、ブックマークメニューなど。  
  ブラウザ画面のうち要求したページが表示されるメインウィンドウを除く全ての部分。
2. **ブラウザエンジン:** UIとレンダリングエンジンの間の処理を整理する。
3. **レンダリングエンジン:** 要求されたコンテンツの表示。（HTMLが要求された場合、HTMLとCSSを解析し、解析したものを表示する）
4. **ネットワーキング:** HTTPリクエストなどのネットワーク呼び出しに使用される。  
  プラットフォームに依存しないインターフェースと、プラットフォームごとの下部の実装がある。
5. **UIバックエンド:** コンボボックスやウィンドウなど基本的なウィジェットの描画に使用。プラットフォームに依存しない汎用的なインターフェースを公開。  
  その下ではオペレーティングシステムのユーザーインターフェースメソッドを使用している。
6. **JavaScriptインタープリタ:** JavaScriptコードの解析と実行に使用。
7. **データストレージ:** 永続的なレイヤ。ブラウザではCookieなど様々なデータをハードディスクに保存する必要がある。  
  HTML5では、ブラウザ内の完全で軽量なデータベースである「ウェブデータベース」が定義されている。

[補足]  

 - Chromeではレンダリングエンジンの複数のインスタンス(各タブ1つずつ)が保持されるため、それぞれのタブは別々のプロセス。

### レンダリングエンジン

- 要求されたコンテンツをブラウザに表示することがレンダリングエンジンの仕事

#### レンダリングエンジンのフロー

1. HTMLドキュメントの解析を開始し、タグを「コンテンツツリー」というDOMノードに変換。  
   スタイルの情報、HTML内の視覚的な指示を組み合わせて「レンダツリー」という別のツリーが作成される。
   - レンダツリーには色や寸法などの視覚的な属性位を持つ矩形が含まれている。
2. レンダツリーが構築されると「レイアウト」処理に移り、画面に表示される正確な座標が各ノードに割り当てられる。
3. ようやく「描画」、レンダツリーが走査され、UIバックエンドレイヤを使用して各ノードが描画される。

上記のような段階を経て、ブラウザに何かが表示されている。  
ユーザが快適に操作できるよう、レンダリングエンジンはできるだけ早くのコンテンツを画面に表示しようとする。  
全てのHTMLが解析されるのを待ってからレンダーツリーの構築とレイアウトを開始するわけではなく、コンテンツの一部が解析され、  
表示される間に、ネットワークから残りのコンテンツが届いて処理が続けられる。  

